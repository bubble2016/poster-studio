# 更新日志
## 2026-02-13（v3.0.0 大版本）

> 相比上一版本（`v2.1.1`），本次聚焦海报视觉质感重构与关键交互顺序优化，提升出图真实感与操作安全性。

### 新增
- 新增双层卡片强化渲染：
  - 后层卡片与前层卡片形成更明显的层间错位与压叠关系。
  - 增加后层描边、高光与层间投影，双层结构更清晰。
- 新增堆叠卡片“随手叠放”效果：
  - 底层卡片支持错位与轻微旋转，模拟两张纸在桌面随机摆放。
  - 增加上层卡片压边投影，3D 层次更自然。
- 新增翻页角抗锯齿重绘方案：
  - 翻页角采用局部超采样后回缩，减少锯齿。
  - 折角区域支持挖空，底部可透出背景图。

### 优化
- 设置菜单交互顺序优化：
  - 登录状态下，“打开设置”自动置于“退出登录”上方，降低误触退出概率。
- 底部店铺名称字号上调一档，品牌信息识别更清晰。

### 修复
- 修复翻页角细节在部分场景下不够真实、纸张层次弱的问题。
- 修复预览生成稳定性问题（回退不符合预期的标语放射效果实现）。

### 验证结果
- 本地执行：`pytest -q`
- 结果：`3 passed`
- 本地执行：`python -m py_compile app.py poster_engine.py`
- 结果：通过
- 本地执行：`node --check static/app.js`
- 结果：通过
## 2026-02-13（v2.1.1）

> 相比上一版本（`e591300`，v2.1.0），本次聚焦价格编辑器可用性、放假模板编辑模式切换，以及模板判定逻辑可靠性。

### 新增
- 新增“模板元数据”能力：
  - 后端新增 `SYSTEM_TEMPLATE_META`，支持模板级标记（如 `is_holiday`）。
  - `GET /api/init` 新增 `system_template_meta` 返回字段。
- 新增价格表编辑器完整数据流：
  - 支持正文与结构化价格行互相同步（含单价、区间、文字模式）。
  - 支持附加说明独立编辑并在生成时合并回正文。

### 优化
- 移动端价格表布局优化：
  - 列宽重分配（优先保障“类型/单位”可读性）。
  - 输入框与区间输入在窄屏下不再横向挤出。
  - 超窄屏（`max-width: 560px`）区间输入自动单列。
- 编辑区交互优化：
  - 移除“从正文导入”按钮。
  - “新增一行”按钮下移至价格表底部，操作路径更直观。

### 修复
- 修复手机端价格表内容偏移到右侧、可视区域不完整的问题。
- 修复新增/删除/修改价格及附加说明后，预览区未及时更新的问题。
- 修复放假模板模式切换：
  - 放假模板显示正文输入，隐藏价格编辑区。
  - 放假模板隐藏“自动格式化 / 批量调价”按钮。
- 修复“放假模板判定依赖名称匹配”的不稳定问题，改为元数据判定并增加前端容错。

### 验证结果
- 本地执行：`pytest -q`
- 结果：`3 passed`
## 2026-02-13（v2.1.0）

> 相比上一版本（`3559d33`，v2.0.0），本次聚焦 Web 端交互体验升级，重点完善移动端可视空间、桌面端全屏预览与设置入口可达性。

### 新增
- 新增“全屏预览”完整交互链路：
  - 移动端支持全屏预览 + 编辑抽屉展开/收起。
  - 桌面端支持按钮触发全屏（优先 Fullscreen API，失败自动降级）。
  - 桌面端支持双击预览区一键进/退全屏。
- 新增首次使用提示：首次进入页面自动提示“包站名称、手机号等信息在设置中填写”，并在本地记忆已读状态。

### 优化
- 顶部标题栏空间压缩与状态切换优化：
  - 移动端滚动时自动收起为超薄头部，回顶后恢复。
  - 移动端顶部卡片、标题层级、按钮与卡片内边距进一步紧凑化。
  - 桌面端标题栏改为近全宽自适应布局，同时降低高度占用并去除顶部留白。
- 设置入口视觉重构：
  - 设置按钮改为“三道杠”图标。
  - 去除外圈/底圈，仅保留图标级轻量动态发光效果。
- 预览展示策略优化：
  - 桌面端全屏预览改为 `contain`，确保显示全图不裁切。
  - 全屏态信息层级与对比度调整，提升观看清晰度。

### 修复
- 修复桌面端点击设置时可能出现的层级错位/被内容遮挡问题（提升顶部区域层级）。
- 修复移动端设置页标签点击出现系统浅蓝高亮块的问题（移除 `tap highlight`）。

### 缓存刷新
- 更新静态资源版本号（`style.css`、`app.js`）以确保发布后前端缓存及时生效。
## 2026-02-13（v2.0.0 大版本）

> 相比上一版本（`01e04ed`，2026-02-12），本次为一次覆盖安全、数据持久化、合规页面与测试体系的综合升级。

### 重大变更（可能影响旧流程）
- 导出文件目录结构升级为“按用户隔离”：
  - 旧：`web_data/outputs/<filename>`
  - 新：`web_data/outputs/<user_id>/<filename>`
- 下载接口新增归属校验：
  - `GET /download/<path>` 现在仅允许下载“当前登录/会话用户自己的导出文件”。
  - 对跨用户下载、非导出目录路径访问统一返回 `403`。
- 新增导出文件归属索引：`web_data/output_index.json`，用于精确记录导出文件所属用户与生成时间。

### 新增
- 新增法律页面与路由：
  - `GET /terms` 用户协议页
  - `GET /privacy` 隐私政策页
- 新增访客草稿能力（前端本地持久化）：
  - 访客模式自动保存编辑内容与配置到 `localStorage`。
  - 支持草稿有效期与版本校验。
  - 设置菜单新增“清空访客草稿”入口。
  - 登录时支持将访客草稿迁移到账号配置。
- 新增自动化测试体系（pytest）：
  - 下载归属权限测试（本人可下、他人不可下）。
  - 非导出目录下载拦截测试。
  - 内容校验与批量调价接口回归测试。

### 优化
- 底部版权区补充“用户协议 / 隐私政策”跳转链接，合规入口更清晰。
- 推荐主题色重设计为 6 个高区分度主流色：
  - `#D32F2F`、`#2563EB`、`#16A34A`、`#EA580C`、`#7C3AED`、`#0891B2`
- 推荐色板布局由 7 列改为 6 列，视觉更统一。

### 工程与依赖
- 新增测试依赖：`pytest>=8.0.0`（`requirements.txt`）。
- 新增测试目录：`tests/conftest.py`、`tests/test_app_security.py`。

### 验证结果
- 本地执行：`pytest -q`
- 结果：`3 passed`
## 2026-02-12（体验修复与主题联动）

### 修复
- 修复“批量调价无效”问题：
  - 支持无单位价格行（如 【工厂黄板】：1350）参与调价。
  - 支持区间价格（如 800-900）联动调整。
  - 支持“上调/下调”文案自动同步调整值。
  - 避免误改日期、电话等非价格数字。
- 修复前端批量调价输入解析：-30、+50、全角 ＋/－ 均可正确识别。
- 修复主题色设置“看起来无效”的问题，前端与海报渲染已打通主题色联动。

### 新增
- 设置页新增“价格颜色模式”开关：
  - 保留涨跌红绿（默认）：上调/涨为红色，下调/跌/降为绿色，其他价格跟随主题色。
  - 跟随主题色：价格统一跟随主题色。

### 优化
- 前端主题色实时生效：
  - 设置页标签样式随主题色变化。
  - 生成按钮及相关主按钮渐变色随主题色变化。
- 海报价格区域视觉优化：
  - 价格数字与单位颜色可按模式切换（主题色 / 涨跌红绿）。
  - 隔行底色恢复固定灰色，不再随主题色变化。
- “温馨提示”样式改为精准匹配：仅标题行（温馨提示/温馨提示：）加粗，正文保持正常字重。
- 强化前后端容错：接口错误提示更明确，上传与生成防重复提交，预览请求竞态处理更稳定。
## 2026-02-12（发布补充）

### 新增
- 新增部署文档 DEPLOY.md，提供 POSTER_DATA_DIR 持久化目录配置与跨平台启动示例。

### 优化
- 服务端数据目录支持环境变量 POSTER_DATA_DIR，可将用户数据放置到代码目录外，避免发布覆盖。
- 新增 .gitignore 忽略 web_data/，防止用户配置与上传素材被持续纳入版本库。

### 同步说明
- 已将 web_data/ 从 Git 跟踪中移除（仅移除索引，不删除本地文件），后续发布默认不再覆盖用户数据。

## 2026-02-12

### 新增
- 新增 Logo 裁剪弹窗，上传 Logo 时可实时缩放和位移后再上传。
- 新增素材缩略图预览（背景图、Logo、印章、二维码）。
- 新增主题色推荐色板与十六进制颜色显示联动。
- 新增水印密度配置项（`watermark_density`），支持 0.5 到 2.0 区间调节。
- 新增图片资源访问接口 `GET /asset/<path:relpath>`，用于安全展示上传素材与预设图。
- 新增字体文件 `fonts/NotoSansSC-VF.ttf` 与背景预设 `presets/preset_noir_depth.png`。

### 优化
- 访客模式默认清空 Logo、印章、二维码素材，避免误用站点已有品牌元素。
- 海报样式重构：
  - `soft` 统一映射到 `outline_pro`（透视金属）。
  - `fold`、`sidebar` 统一回退到 `single`。
  - `outline` 强化为棱边立体风格，增强厚边、阴影和高光层次。
  - `outline_pro` 增加透视爬行效果与金色描边视觉。
- 水印铺排逻辑优化：密度越高间距越小，适配不同底图内容密度。
- 移除“价格低于 100 元可能过低”的校验提示，减少误报。
- 设置页与首页交互优化：
  - 随机背景变体增强页面氛围。
  - 登录/切换账号按钮在已登录状态下先自动保存配置再退出。
  - 移动端隐藏“今天/明天”快捷按钮并优化布局。

### 界面调整
- 首页品牌文案更新为“打包站公告发布工具”。
- 设置页“视觉风格”新增推荐主题色快捷选择。
- 设置页“图片素材”区域新增访客提示文案。
- 新增 Logo 裁剪弹窗 UI 与对应交互控件。
- 更新静态资源版本号（`style.css`、`app.js`）以确保前端缓存刷新。

### 同步说明
- 已同步当前工作区改动（包含代码、素材与用户配置文件）。





