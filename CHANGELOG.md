# 更新日志
## 2026-02-24（v4.0.1）

> 本次为 `v4.0.0` 后的界面一致性迭代，聚焦模板管理、素材上传与移动端交互细节。

### 新增
- 新增模板与导出格式增强下拉（向上展开）交互与层级管理。
- 新增素材缩略图占位图体系（背景图、Logo、印章、二维码）及占位态显示策略。
- 新增背景图与 Logo 的“随机”快捷切换入口。

### 优化
- 优化模板下拉选中态颜色：改为跟随主题色。
- 优化上传文件选择框为扁平风格，弱化粗体与高对比提示文本。
- 优化移动端按钮点击反馈：移除浅蓝色点击高亮块。
- 优化海报顶部 Logo 尺寸（`198 -> 220`），提升视觉平衡。
- 优化确认类弹窗：隐藏与“取消”语义重复的右上角“关闭”按钮。

### 修复
- 修复价格表拖拽选中行高亮透明度不一致问题，统一为主题色 `15%` 透明度。

## 2026-02-24（v4.0.0 大版本）

> 相比上一版本（`v3.0.7`），本次聚焦预设资源结构重整、默认标识体系升级与前端交互冗余清理。

### 新增
- 新增默认圆形 Logo 生成与资源池：
  - `default_logo_recycle_leaf.png`
  - `default_logo_mint_circle.png`
- 新增默认 Logo 自动迁移策略：
  - 用户配置缺失、旧默认 Logo（`default_logo_kraft_stamp.png`）或路径失效时，自动替换为可用默认 Logo。
- 新增预设资源目录规范：
  - 背景图统一归档到 `presets/backgrounds/`
  - 默认 Logo 统一归档到 `presets/logos/`

### 优化
- 优化纸张风预设质感：
  - `再生纸纤维` 强化多尺度纹理、纤维细节与浮雕层次。
  - `揉皱牛皮纸` 强化折痕、细褶与边缘压暗效果。
- 优化 Logo 圆形裁切边缘抗锯齿与白色环形底托渲染，提升出图精细度。
- 优化模板管理折叠提示逻辑与文案切换，减少首次引导后的干扰。

### 清理
- 清理前端重复逻辑：卡片风格旧值映射统一收敛为 `normalizeCardStyle()`。
- 清理预设根目录冗余素材副本，预设资源改为按功能分目录管理。
- 清理静态资源版本不一致问题，统一版本号为 `20260224v400`（`favicon`、`style.css`、`app.js`、`admin.js`）。
- 清理本地测试缓存目录追踪风险：补充 `.gitignore` 忽略 `.pytest_cache/`。
## 2026-02-24（v3.0.7）

> 相比上一版本（`v3.0.6`），本次聚焦首屏加载反馈优化、预设素材升级与部署包清理。

### 新增
- 新增预览分阶段加载文案：`正在加载配置` -> `正在准备模板` -> `正在生成预览`。
- 新增慢网提示：预览请求超过 `2.5s` 自动提示“网络较慢，已进入后台加载，不影响后续操作”。
- 新增 2 款废纸风预设背景：
  - `preset_recycled_paper.png`（再生纸纤维）
  - `preset_crumpled_kraft.png`（揉皱牛皮纸）

### 优化
- 优化预设素材结构：移除 `preset_noir_depth.png` 与 `preset_sunset_amber.png`，替换为废纸风格素材。

### 清理
- 清理部署无关目录与文件：`tests/`、`.pytest_cache/`、`__pycache__/`、`output/`。
- 更新静态资源版本号（`style.css`、`app.js`、`admin.js`）为 `20260224a2`，确保前端缓存及时刷新。
## 2026-02-23（v3.0.6）

> 相比上一版本（`v3.0.5`），本次聚焦模板删除安全性、下载稳定性与设置页签滚动体验统一，并清理临时 UI 调整带来的冗余改动。

### 新增
- 新增模板删除二次确认：
  - 删除自定义模板前弹窗确认，降低误删风险。
  - 删除成功后新增 `Toast` 反馈，形成完整操作闭环。
- 新增导出下载兜底策略：
  - 优先使用 `<a download>` 直接下载文件。
  - 下载触发失败时自动回退到新窗口打开下载链接。

### 优化
- 统一设置面板滚动交互：
  - “视觉风格”页签与“图片素材”页签一致，向下滚动时自动隐藏顶部标签栏，回滚时恢复。

### 清理
- 清理临时视觉入口改动，恢复“隐私政策/用户协议”到既有展示路径与样式。
- 更新静态资源版本号（`style.css`、`app.js`）为 `20260223m4`，确保前端缓存及时刷新。

## 2026-02-23（v3.0.5）

> 相比上一版本（v3.0.4），本次聚焦模板管理交互动效与“生成后文案复制”体验完善。

### 新增
- 新增“生成成功后自动弹出文案复制窗口”流程：
  - 自动汇总标题、日期与正文内容到可复制文本框。
  - 支持一键复制，优先使用系统剪贴板，失败时回退为手动复制指引（Ctrl+C）。

### 优化
- 优化模板管理展开/收起体验：
  - 从瞬时隐藏改为平滑过渡（高度、透明度、轻微位移联动），减少突兀感。
  - 保持原有“展开/收起”按钮与提示逻辑不变。
- 优化文案复制弹窗 UI：
  - 去掉右上角冗余“关闭”按钮，仅保留底部主关闭按钮并居中展示。
  - 复制反馈改为按钮内动态提示（如“已复制”），避免侧边提示挤压导致错位。

### 修复
- 修复文案复制成功提示在部分分辨率下换行、错位并挤压按钮布局的问题。
- 更新静态资源版本号（style.css、app.js）以确保前端缓存及时生效。

## 2026-02-21（v3.0.4）

> 相比上一版本（`v3.0.3`），本次聚焦上传素材管理的闭环体验与设置面板在窄屏下的可视空间优化。

### 新增
- 新增上传素材一键删除功能：
  - 支持删除已上传的背景图、Logo、印章与二维码。
  - 删除背景图时自动回退到“自定义”模式并刷新预设网格状态。
  - 增加删除二次确认，防止误触。
- 新增设置面板滚动自动隐藏交互：
  - 在移动端/窄屏下，进入“图片素材”标签页向下滚动时自动隐藏顶部标签栏。
  - 向上滚动或回顶时自动恢复显示，最大化素材列表的编辑可视区域。
- 新增 `部署必看-保留与删除清单.md`：
  - 明确发布过程中应保留的配置文件（`users.json`、`web_config.json` 等）与可清理的临时目录。

### 优化
- 优化预设素材库：
  - 精简预设列表，移除 3 款低区分度素材（`frosted_grey`、`kraft_pro`、`obsidian_grid`）。
  - 更新并同步现有 7 款主流预设素材（`aurora_cyan`、`fluid_blue` 等）的视觉表现。
- 优化设置弹窗高度逻辑：
  - 统一桌面端与移动端弹窗高度上限（`860px`），避免大屏下弹窗过长导致的操作不便。
- 优化上传缩略图交互：
  - 增加删除按钮的悬停显现与微动效。
  - 适配触摸屏设备，删除按钮以低透明度常驻显示，提升移动端可发现性。

### 修复
- 修复在设置面板内切换标签页时，滚动位置未自动回顶的问题。
- 修复部分场景下“清除访客草稿”后上传预览图仍残留的问题。

## 2026-02-15（v3.0.3）

> 相比上一版本（`v3.0.2`），本次聚焦移动端提示气泡可点击性与提示视觉一致性优化。

### 修复
- 修复模板管理“展开提示”气泡位置易被底部操作区遮挡的问题：
  - 气泡从“展开按钮左下方”调整为“左上方”显示，避免与“生成”按钮区域重叠。
  - 同步调整箭头方向与锚点，保证提示指向关系正确。

### 优化
- 统一设置入口提示气泡与模板管理提示气泡风格为白色半透明：
  - 统一背景、描边、阴影与毛玻璃效果，视觉风格一致。
  - 统一“知道了”按钮样式（圆角、边框、文字与背景透明度），降低界面割裂感。
## 2026-02-14（v3.0.2）

> 相比上一版本（`v3.0.1`），本次聚焦票据/极光风格质感升级与预览加载稳定性增强。

### 新增
- 新增票据风格细节渲染：
  - 加入票据卡片阴影、双层描边与内边框，提升实体感。
  - 新增左右连续齿孔与中部撕裂虚线，强化票据识别度。
- 新增预览图片加载重试机制（前端）：
  - 首次加载失败时自动追加时间戳参数重试 1 次，降低缓存或瞬时网络导致的失败率。

### 优化
- 优化极光风格（aurora）玻璃质感：
  - 增加卡片区域背景模糊、半透明基底与冷色折射描边。
  - 重绘边缘高光与柔光外缘，减少“实体白卡”观感，强化磨砂玻璃效果。
- 优化极光风格下正文分行底纹：
  - 在 `aurora` 样式中关闭交替行背景块，避免干扰通透视觉层次。
- 优化预览更新流程：
  - 改为预加载成功后再替换 `previewImage`，并统一在成功回调中设置“已加载”状态。
  - 移除初始化阶段对同一图片节点的全局 `load/error` 监听，避免重复状态写入。
## 2026-02-14（v3.0.1）

> 相比上一版本（`v3.0.0`），本次聚焦日期自动更新可靠性与批量调价区间处理准确性。

### 修复
- 修复批量调价中“区间价格被重复调整”的问题：
  - 先对区间价格（支持 `-` / `~` / `～` / `至` / `到`）做占位保护。
  - 再执行“上调/下调”文案与单值价格替换，最后恢复区间值。
  - 避免 `1500-1550` 在同一次调价中被二次加减。
- 修复预览刷新时覆盖日期输入框的问题：
  - 前端预览成功后不再强制用接口返回值回写 `dateInput`，避免用户手动日期被意外改写。

### 新增
- 新增跨天自动刷新日期机制（前端）：
  - 通过 `visibilitychange`、`focus`、30 秒轮询三条路径检测自然日变化。
  - 当页面跨天后，自动把“今天/明天/后天/昨天”及相对日期值按新日期滚动到下一天。
  - 自动触发草稿保存与预览刷新，减少次日人工重复操作。
- 新增批量调价回归测试：`tests/test_batch_adjust.py`
  - 覆盖中划线区间（`1500-1550`）只调整一次。
  - 覆盖波浪线区间（`1500~1550`）的下调行为。

### 优化
- 日期输入初始化逻辑统一为当天绝对日期格式（`YYYY年MM月DD日`），减少“相对日期文本”在长时间打开页面后的歧义。
- “今天/明天”快捷按钮改为直接写入绝对日期，保证预览与导出结果稳定一致。
## 2026-02-13（v3.0.0 大版本）

> 相比上一版本（`v2.1.1`），本次聚焦海报视觉质感重构与关键交互顺序优化，提升出图真实感与操作安全性。

### 新增
- 新增双层卡片强化渲染：
  - 后层卡片与前层卡片形成更明显的层间错位与压叠关系。
  - 增加后层描边、高光与层间投影，双层结构更清晰。
- 新增堆叠卡片“随手叠放”效果：
  - 底层卡片支持错位与轻微旋转，模拟两张纸在桌面随机摆放。
  - 增加上层卡片压边投影，3D 层次更自然。
- 新增翻页角抗锯齿重绘方案：
  - 翻页角采用局部超采样后回缩，减少锯齿。
  - 折角区域支持挖空，底部可透出背景图。

### 优化
- 设置菜单交互顺序优化：
  - 登录状态下，“打开设置”自动置于“退出登录”上方，降低误触退出概率。
- 底部店铺名称字号上调一档，品牌信息识别更清晰。

### 修复
- 修复翻页角细节在部分场景下不够真实、纸张层次弱的问题。
- 修复预览生成稳定性问题（回退不符合预期的标语放射效果实现）。

### 验证结果
- 本地执行：`pytest -q`
- 结果：`3 passed`
- 本地执行：`python -m py_compile app.py poster_engine.py`
- 结果：通过
- 本地执行：`node --check static/app.js`
- 结果：通过
## 2026-02-13（v2.1.1）

> 相比上一版本（`e591300`，v2.1.0），本次聚焦价格编辑器可用性、放假模板编辑模式切换，以及模板判定逻辑可靠性。

### 新增
- 新增“模板元数据”能力：
  - 后端新增 `SYSTEM_TEMPLATE_META`，支持模板级标记（如 `is_holiday`）。
  - `GET /api/init` 新增 `system_template_meta` 返回字段。
- 新增价格表编辑器完整数据流：
  - 支持正文与结构化价格行互相同步（含单价、区间、文字模式）。
  - 支持附加说明独立编辑并在生成时合并回正文。

### 优化
- 移动端价格表布局优化：
  - 列宽重分配（优先保障“类型/单位”可读性）。
  - 输入框与区间输入在窄屏下不再横向挤出。
  - 超窄屏（`max-width: 560px`）区间输入自动单列。
- 编辑区交互优化：
  - 移除“从正文导入”按钮。
  - “新增一行”按钮下移至价格表底部，操作路径更直观。

### 修复
- 修复手机端价格表内容偏移到右侧、可视区域不完整的问题。
- 修复新增/删除/修改价格及附加说明后，预览区未及时更新的问题。
- 修复放假模板模式切换：
  - 放假模板显示正文输入，隐藏价格编辑区。
  - 放假模板隐藏“自动格式化 / 批量调价”按钮。
- 修复“放假模板判定依赖名称匹配”的不稳定问题，改为元数据判定并增加前端容错。

### 验证结果
- 本地执行：`pytest -q`
- 结果：`3 passed`
## 2026-02-13（v2.1.0）

> 相比上一版本（`3559d33`，v2.0.0），本次聚焦 Web 端交互体验升级，重点完善移动端可视空间、桌面端全屏预览与设置入口可达性。

### 新增
- 新增“全屏预览”完整交互链路：
  - 移动端支持全屏预览 + 编辑抽屉展开/收起。
  - 桌面端支持按钮触发全屏（优先 Fullscreen API，失败自动降级）。
  - 桌面端支持双击预览区一键进/退全屏。
- 新增首次使用提示：首次进入页面自动提示“包站名称、手机号等信息在设置中填写”，并在本地记忆已读状态。

### 优化
- 顶部标题栏空间压缩与状态切换优化：
  - 移动端滚动时自动收起为超薄头部，回顶后恢复。
  - 移动端顶部卡片、标题层级、按钮与卡片内边距进一步紧凑化。
  - 桌面端标题栏改为近全宽自适应布局，同时降低高度占用并去除顶部留白。
- 设置入口视觉重构：
  - 设置按钮改为“三道杠”图标。
  - 去除外圈/底圈，仅保留图标级轻量动态发光效果。
- 预览展示策略优化：
  - 桌面端全屏预览改为 `contain`，确保显示全图不裁切。
  - 全屏态信息层级与对比度调整，提升观看清晰度。

### 修复
- 修复桌面端点击设置时可能出现的层级错位/被内容遮挡问题（提升顶部区域层级）。
- 修复移动端设置页标签点击出现系统浅蓝高亮块的问题（移除 `tap highlight`）。

### 缓存刷新
- 更新静态资源版本号（`style.css`、`app.js`）以确保发布后前端缓存及时生效。
## 2026-02-13（v2.0.0 大版本）

> 相比上一版本（`01e04ed`，2026-02-12），本次为一次覆盖安全、数据持久化、合规页面与测试体系的综合升级。

### 重大变更（可能影响旧流程）
- 导出文件目录结构升级为“按用户隔离”：
  - 旧：`web_data/outputs/<filename>`
  - 新：`web_data/outputs/<user_id>/<filename>`
- 下载接口新增归属校验：
  - `GET /download/<path>` 现在仅允许下载“当前登录/会话用户自己的导出文件”。
  - 对跨用户下载、非导出目录路径访问统一返回 `403`。
- 新增导出文件归属索引：`web_data/output_index.json`，用于精确记录导出文件所属用户与生成时间。

### 新增
- 新增法律页面与路由：
  - `GET /terms` 用户协议页
  - `GET /privacy` 隐私政策页
- 新增访客草稿能力（前端本地持久化）：
  - 访客模式自动保存编辑内容与配置到 `localStorage`。
  - 支持草稿有效期与版本校验。
  - 设置菜单新增“清空访客草稿”入口。
  - 登录时支持将访客草稿迁移到账号配置。
- 新增自动化测试体系（pytest）：
  - 下载归属权限测试（本人可下、他人不可下）。
  - 非导出目录下载拦截测试。
  - 内容校验与批量调价接口回归测试。

### 优化
- 底部版权区补充“用户协议 / 隐私政策”跳转链接，合规入口更清晰。
- 推荐主题色重设计为 6 个高区分度主流色：
  - `#D32F2F`、`#2563EB`、`#16A34A`、`#EA580C`、`#7C3AED`、`#0891B2`
- 推荐色板布局由 7 列改为 6 列，视觉更统一。

### 工程与依赖
- 新增测试依赖：`pytest>=8.0.0`（`requirements.txt`）。
- 新增测试目录：`tests/conftest.py`、`tests/test_app_security.py`。

### 验证结果
- 本地执行：`pytest -q`
- 结果：`3 passed`
## 2026-02-12（体验修复与主题联动）

### 修复
- 修复“批量调价无效”问题：
  - 支持无单位价格行（如 【工厂黄板】：1350）参与调价。
  - 支持区间价格（如 800-900）联动调整。
  - 支持“上调/下调”文案自动同步调整值。
  - 避免误改日期、电话等非价格数字。
- 修复前端批量调价输入解析：-30、+50、全角 ＋/－ 均可正确识别。
- 修复主题色设置“看起来无效”的问题，前端与海报渲染已打通主题色联动。

### 新增
- 设置页新增“价格颜色模式”开关：
  - 保留涨跌红绿（默认）：上调/涨为红色，下调/跌/降为绿色，其他价格跟随主题色。
  - 跟随主题色：价格统一跟随主题色。

### 优化
- 前端主题色实时生效：
  - 设置页标签样式随主题色变化。
  - 生成按钮及相关主按钮渐变色随主题色变化。
- 海报价格区域视觉优化：
  - 价格数字与单位颜色可按模式切换（主题色 / 涨跌红绿）。
  - 隔行底色恢复固定灰色，不再随主题色变化。
- “温馨提示”样式改为精准匹配：仅标题行（温馨提示/温馨提示：）加粗，正文保持正常字重。
- 强化前后端容错：接口错误提示更明确，上传与生成防重复提交，预览请求竞态处理更稳定。
## 2026-02-12（发布补充）

### 新增
- 新增部署文档 DEPLOY.md，提供 POSTER_DATA_DIR 持久化目录配置与跨平台启动示例。

### 优化
- 服务端数据目录支持环境变量 POSTER_DATA_DIR，可将用户数据放置到代码目录外，避免发布覆盖。
- 新增 .gitignore 忽略 web_data/，防止用户配置与上传素材被持续纳入版本库。

### 同步说明
- 已将 web_data/ 从 Git 跟踪中移除（仅移除索引，不删除本地文件），后续发布默认不再覆盖用户数据。

## 2026-02-12

### 新增
- 新增 Logo 裁剪弹窗，上传 Logo 时可实时缩放和位移后再上传。
- 新增素材缩略图预览（背景图、Logo、印章、二维码）。
- 新增主题色推荐色板与十六进制颜色显示联动。
- 新增水印密度配置项（`watermark_density`），支持 0.5 到 2.0 区间调节。
- 新增图片资源访问接口 `GET /asset/<path:relpath>`，用于安全展示上传素材与预设图。
- 新增字体文件 `fonts/NotoSansSC-VF.ttf` 与背景预设 `presets/preset_noir_depth.png`。

### 优化
- 访客模式默认清空 Logo、印章、二维码素材，避免误用站点已有品牌元素。
- 海报样式重构：
  - `soft` 统一映射到 `outline_pro`（透视金属）。
  - `fold`、`sidebar` 统一回退到 `single`。
  - `outline` 强化为棱边立体风格，增强厚边、阴影和高光层次。
  - `outline_pro` 增加透视爬行效果与金色描边视觉。
- 水印铺排逻辑优化：密度越高间距越小，适配不同底图内容密度。
- 移除“价格低于 100 元可能过低”的校验提示，减少误报。
- 设置页与首页交互优化：
  - 随机背景变体增强页面氛围。
  - 登录/切换账号按钮在已登录状态下先自动保存配置再退出。
  - 移动端隐藏“今天/明天”快捷按钮并优化布局。

### 界面调整
- 首页品牌文案更新为“打包站公告发布工具”。
- 设置页“视觉风格”新增推荐主题色快捷选择。
- 设置页“图片素材”区域新增访客提示文案。
- 新增 Logo 裁剪弹窗 UI 与对应交互控件。
- 更新静态资源版本号（`style.css`、`app.js`）以确保前端缓存刷新。

### 同步说明
- 已同步当前工作区改动（包含代码、素材与用户配置文件）。











